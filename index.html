<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UID Token Checker</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  th { background-color: #f2f2f2; }
  button { margin: 5px; padding: 8px 12px; cursor: pointer; }
</style>
</head>
<body>

<h1>UID Token Checker</h1>

<input type="file" id="fileInput" accept=".csv">
<button id="startBtn">Start Checking</button>
<button id="downloadCSV">Download CSV</button>
<button id="downloadJSON">Download JSON</button>

<table id="resultTable">
  <thead>
    <tr>
      <th>UID</th>
      <th>Status</th>
      <th>Token</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let liveRows = [];
let deadRows = [];

const proxies = [
"https://api.allorigins.win/raw?url=",
"https://thingproxy.freeboard.io/fetch/",
"https://cors-anywhere.herokuapp.com/",
"https://yacdn.org/proxy/",
"https://corsproxy.io/?",
"https://allorigins.hexlet.app/raw?url=",
"https://cors.bridged.cc/",
"https://cors-proxy.htmldriven.com/?url=",
"https://cors.isomorphic.site/",
"https://cors-anywhere.netlify.app/",
"https://corsproxy.github.io/?",
"https://api.codetabs.com/v1/proxy?quest="
];

function readCSV(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
            const text = e.target.result;
            const rows = text.split(/\r?\n/).filter(r=>r.trim()!=="");
            resolve(rows.map(r=>({uid:r.trim()})));
        };
        reader.onerror = reject;
        reader.readAsText(file);
    });
}

async function fetchWithRetry(url, retries=3) {
    for(let i=0;i<retries;i++){
        try{
            const res = await fetch(url);
            if(!res.ok) throw new Error("HTTP error "+res.status);
            const data = await res.json();
            return data;
        } catch(e){
            if(i === retries-1) throw e;
        }
    }
}

function updateTable() {
    const tbody = document.querySelector("#resultTable tbody");
    tbody.innerHTML = "";
    liveRows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.uid}</td><td>${r.status}</td><td>${r.token}</td>`;
        tbody.appendChild(tr);
    });
    deadRows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.uid}</td><td>${r.status}</td><td>${r.error||""}</td>`;
        tbody.appendChild(tr);
    });
}

async function processUIDs(uids) {
    for(const it of uids){
        let success = false;
        for(const proxy of proxies){
            try{
                const url = proxy + encodeURIComponent(`https://example.com/api/token/${it.uid}`);
                const json = await fetchWithRetry(url, 3);
                let token = json.token || json.jwt || json.access_token;

                if(token && typeof token==="string" && token.startsWith("eyJ")){
                    if(!liveRows.some(l=>l.uid===it.uid)){
                        liveRows.push({uid:it.uid, status:"Live", token});
                        deadRows = deadRows.filter(d=>d.uid!==it.uid);
                        updateTable();
                    }
                    success = true;
                    break;
                }
            } catch(e){
                // skip to next proxy
            }
        }
        if(!success && !deadRows.some(d=>d.uid===it.uid)){
            deadRows.push({uid:it.uid, status:"Dead", error:"Invalid token or proxy HTML"});
            updateTable();
        }
    }
}

document.getElementById("startBtn").addEventListener("click", async ()=>{
    const file = document.getElementById("fileInput").files[0];
    if(!file) return alert("Please select a CSV file");
    const uids = await readCSV(file);
    liveRows = [];
    deadRows = [];
    updateTable();
    await processUIDs(uids);
    alert("Processing completed!");
});

document.getElementById("downloadCSV").addEventListener("click", ()=>{
    const rows = [...liveRows.map(r=>[r.uid,r.status,r.token]), ...deadRows.map(r=>[r.uid,r.status,r.error||""])];
    const csvContent = "data:text/csv;charset=utf-8," + rows.map(e=>e.join(",")).join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "results.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});

document.getElementById("downloadJSON").addEventListener("click", ()=>{
    const allData = [...liveRows,...deadRows];
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData,null,2));
    const link = document.createElement("a");
    link.setAttribute("href", dataStr);
    link.setAttribute("download", "results.json");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});
</script>

</body>
</html>
